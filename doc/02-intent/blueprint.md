# AIOps 系统原始需求文档

## 1. 项目概述

### 1.1 项目背景
随着 IT 系统复杂度的不断提升，传统的运维方式已经难以满足现代化运维的需求。需要构建一个智能化的 AIOps 系统，通过拓扑管理、智能 Agent 和 LLM 技术，实现对 IT 资源的统一管理、智能分析和自动化运维。

### 1.2 项目目标
构建一个基于拓扑图和智能 Agent 的 AIOps 平台，实现：
- 统一管理各类 IT 资源（基础设施、应用、代码仓库、接口、报表等）
- 建立资源间的拓扑关系，支持分层管理
- 通过智能 Agent 实现自动化巡检、故障分析等运维任务
- 提供灵活的 Chatbot 交互界面，支持临时任务执行

### 1.3 核心价值
- 提升运维效率，降低人工成本
- 快速定位故障，缩短故障恢复时间
- 智能化分析，提前发现潜在问题
- 统一管理视图，提高资源可见性

## 2. 核心功能需求

### 2.1 资源管理与拓扑建模

#### 2.1.1 统一资源抽象
系统需要支持管理多种类型的 IT 资源，并将它们统一抽象为拓扑图中的节点。

**资源类型包括但不限于**：
- **基础设施**：服务器、网络设备、存储设备、容器、虚拟机等
- **应用**：微服务应用、单体应用、批处理任务等
- **代码仓库**：Git 仓库、分支、提交记录等
- **接口**：REST API、gRPC 接口、消息队列等
- **报表**：业务报表、监控报表、数据分析报表等
- **中间件**：数据库、缓存、消息队列、配置中心等

**资源属性**：
- 基础属性：名称、类型、描述、标签、创建时间、更新时间
- 状态属性：运行状态、健康状态、告警状态
- 配置属性：配置参数、连接信息、访问凭证
- 监控属性：性能指标、日志信息、链路追踪数据
- 元数据：负责人、团队、环境（开发/测试/生产）
- 权限属性：创建者、所有者列表（Owner）、访问权限

#### 2.1.2 拓扑关系管理
系统需要支持建立和管理节点之间的拓扑关系。

**关系类型**：
- **依赖关系**：应用依赖数据库、应用依赖接口等
- **调用关系**：服务 A 调用服务 B、接口调用链路等
- **部署关系**：应用部署在服务器上、容器运行在宿主机上等
- **归属关系**：接口归属于应用、代码仓库归属于团队等
- **关联关系**：报表关联接口、监控关联应用等

**关系属性**：
- 关系类型、方向（单向/双向）
- 关系强度（强依赖/弱依赖）
- 关系状态（正常/异常）
- 关系元数据（创建时间、更新时间、描述）

#### 2.1.3 分层管理
系统需要支持定义和管理资源的分层结构，实现不同层次的视图展示。

**预定义层次**（从上到下）：
1. **业务层**：业务报表、业务指标、业务流程
2. **业务链路层**：业务接口、API 网关、前端应用
3. **应用层**：微服务应用、后端服务、批处理任务
4. **中间件层**：数据库、缓存、消息队列、配置中心
5. **基础设施层**：服务器、网络设备、存储设备、容器平台

**分层特性**：
- 支持自定义层次定义
- 支持节点在多个层次中出现
- 支持按层次过滤和展示拓扑图
- 支持跨层次的关系展示

#### 2.1.4 拓扑图可视化
系统需要提供强大的拓扑图可视化能力，支持大规模拓扑图的流畅展示和交互。

**布局需求**：
- 系统需要支持多种布局方式，适应不同的拓扑关系展示需求
- 系统需要支持自动布局，节点位置自动计算和分布
- 系统需要支持手动布局，用户可以手动调整节点位置并保存

**交互需求**：
- 系统需要支持拓扑图的缩放操作，用户可以放大或缩小查看细节
- 系统需要支持拓扑图的拖拽操作，用户可以移动画布和节点
- 系统需要支持节点的搜索功能，快速定位目标节点
- 系统需要支持节点和关系的过滤功能，按条件筛选显示内容
- 系统需要支持节点的高亮显示，突出显示选中节点及其关联节点
- 系统需要支持节点的展开和折叠，控制显示的详细程度
- 系统需要支持节点详情的快速查看和编辑
- 系统需要支持节点和关系的快捷操作菜单

**视图需求**：
- 系统需要支持全局视图，展示所有节点和关系
- 系统需要支持层次视图，按层次结构展示节点
- 系统需要支持聚焦视图，聚焦某个节点及其 N 度关系节点
- 系统需要支持路径视图，展示两个节点之间的依赖路径
- 系统需要支持影响分析视图，展示某个节点故障的影响范围

**性能需求**：
- 系统需要支持大规模拓扑图的流畅展示（10000+ 节点）
- 系统需要支持按需加载，避免一次性加载全部数据
- 系统需要根据缩放级别动态调整显示的详细程度
- 系统需要支持相似节点的自动聚合，减少显示复杂度

**导出需求**：
- 系统需要支持拓扑图导出为图片格式
- 系统需要支持拓扑图导出为文档格式（包含拓扑图和节点信息）
- 系统需要支持拓扑数据导出为标准格式（如 JSON、GraphML 等）
- 系统需要支持生成拓扑图的分享链接，并控制访问权限

**样式需求**：
- 系统需要支持自定义节点样式（形状、颜色、图标、大小）
- 系统需要支持自定义关系样式（线型、颜色、箭头、标签）
- 系统需要支持多种主题切换（亮色、暗色、自定义）
- 系统需要根据节点状态自动改变显示样式（正常、警告、异常）

### 2.2 Agent 管理

#### 2.2.1 Agent 定义与配置
系统需要支持定义和管理各种类型的智能 Agent。

**Agent 类型**：
- **巡检 Agent**：定期检查资源健康状态、性能指标
- **故障分析 Agent**：分析故障原因、生成诊断报告
- **根因分析 Agent**：追溯故障根本原因、分析影响范围
- **预测 Agent**：预测资源使用趋势、提前发现潜在问题
- **优化建议 Agent**：提供性能优化、成本优化建议
- **自定义 Agent**：用户自定义的特定任务 Agent

**Agent 配置**：
- 基础信息：名称、类型、描述、版本
- 执行配置：执行频率、超时时间、重试策略
- 输入配置：需要的数据源、监控指标、日志来源
- 输出配置：报告格式、通知方式、存储位置
- 权限配置：可访问的资源范围、操作权限

#### 2.2.3 Agent 执行需求
系统需要提供 Agent 的执行能力和与 LLM 的交互能力。

**执行隔离需求**：
- 系统需要确保 Agent 任务之间相互隔离，避免相互影响
- 系统需要支持 Agent 任务的远程执行，实现负载分散

**资源控制需求**：
- 系统需要支持对 Agent 任务的 CPU 使用限制
- 系统需要支持对 Agent 任务的内存使用限制
- 系统需要支持 Agent 任务的超时控制，超时自动终止
- 系统需要支持 Agent 任务的并发数量限制

**数据获取需求**：
- 系统需要支持从监控系统获取实时和历史监控数据
- 系统需要支持从日志系统获取日志数据，并支持过滤和聚合
- 系统需要支持从 CMDB 获取资源配置信息
- 系统需要支持从配置中心获取应用配置
- 系统需要支持从代码仓库获取配置文件
- 系统需要支持从链路追踪系统获取调用链数据

**LLM 交互需求**：
- 系统需要支持 Agent 从数据源收集相关数据
- 系统需要支持对收集的数据进行预处理（清洗、过滤、聚合）
- 系统需要支持基于模板构造提示词，并填充数据
- 系统需要支持在提示词中包含上下文信息（资源信息、历史结果等）
- 系统需要支持根据任务类型选择合适的 LLM 服务
- 系统需要支持 LLM 调用失败的处理（重试、降级、告警）
- 系统需要支持解析 LLM 返回的结果，提取结构化信息
- 系统需要支持验证 LLM 返回结果的合理性
- 系统需要支持存储分析结果并关联到资源节点
- 系统需要支持根据配置发送结果通知

**上下文管理需求**：
- 系统需要保持 Agent 执行过程中的上下文信息
- 系统需要支持引用历史分析结果，提供连续性分析
- 系统需要支持在上下文中包含资源的配置、状态、监控数据
- 系统需要支持上下文过长时的自动压缩或摘要

**Agent 编排需求**：
- 系统需要支持多个 Agent 按顺序执行（串行编排）
- 系统需要支持多个 Agent 同时执行（并行编排）
- 系统需要支持根据条件决定执行哪个 Agent（条件编排）
- 系统需要支持重复执行 Agent 直到满足条件（循环编排）

#### 2.2.2 Agent 与节点关联
系统需要支持将 Agent 关联到拓扑图的节点上。

**关联方式**：
- 单节点关联：Agent 关联到单个节点
- 多节点关联：Agent 关联到一组节点
- 层次关联：Agent 关联到某个层次的所有节点
- 动态关联：根据标签、类型等条件动态关联

**关联配置**：
- 执行范围：关联的节点范围
- 执行策略：串行执行、并行执行、按依赖顺序执行
- 触发条件：定时触发、事件触发、手动触发
- 结果处理：结果聚合、异常告警、报告生成

### 2.3 LLM 与提示词管理

#### 2.3.1 LLM 配置管理
系统需要支持配置和管理多个 LLM 服务。

**LLM 配置**：
- 基础信息：名称、类型（OpenAI、Claude、本地模型等）、版本
- 连接配置：API 端点、认证信息、超时设置
- 模型参数：温度、最大 Token 数、Top-P 等
- 成本配置：Token 单价、预算限制、成本告警
- 性能配置：并发限制、速率限制、重试策略

**LLM 能力**：
- 支持多个 LLM 服务并存
- 支持 LLM 服务的切换和降级
- 支持 LLM 调用的监控和统计
- 支持 LLM 成本的追踪和控制

#### 2.3.2 提示词管理
系统需要支持管理和版本化提示词模板。

**提示词模板**：
- 基础信息：名称、类型、描述、版本
- 模板内容：提示词文本、变量占位符
- 适用场景：巡检、故障分析、根因分析等
- 关联 Agent：使用该提示词的 Agent 列表
- 测试数据：用于测试提示词效果的样例数据

**提示词特性**：
- 支持提示词的版本管理
- 支持提示词的 A/B 测试
- 支持提示词效果的评估和优化
- 支持提示词的导入导出

### 2.4 任务执行与调度

#### 2.4.1 任务类型
系统需要支持多种类型的任务执行。

**日常巡检任务**：
- 定期检查资源健康状态
- 检查性能指标是否正常
- 检查配置是否符合规范
- 生成巡检报告

**故障分析任务**：
- 分析故障现象和症状
- 收集相关日志和监控数据
- 分析故障原因和影响范围
- 生成故障分析报告

**根因分析任务**：
- 追溯故障的根本原因
- 分析故障传播路径
- 识别关键影响节点
- 提供修复建议

**优化建议任务**：
- 分析资源使用情况
- 识别性能瓶颈
- 提供优化建议
- 评估优化效果

#### 2.4.2 任务调度
系统需要支持灵活的任务调度机制。

**调度方式**：
- 定时调度：按固定周期执行（每小时、每天、每周等）
- 事件触发：基于告警、状态变化等事件触发
- 手动触发：用户手动启动任务
- 依赖触发：基于其他任务的完成状态触发

**调度配置**：
- 执行时间：执行周期、执行时间窗口
- 执行策略：串行、并行、优先级
- 失败处理：重试次数、重试间隔、失败告警
- 结果处理：结果存储、通知方式、报告生成

### 2.5 报告模板管理

#### 2.5.1 报告模板定义
系统需要支持自定义报告模板，实现分析结果的格式化输出。

**报告类型**：
- **巡检报告**：日常巡检任务的结果报告
- **故障分析报告**：故障分析任务的诊断报告
- **根因分析报告**：根因分析任务的溯源报告
- **优化建议报告**：性能优化和成本优化建议报告
- **趋势分析报告**：资源使用趋势和预测报告
- **自定义报告**：用户自定义的特定场景报告

**模板配置**：
- 基础信息：模板名称、类型、描述、版本
- 模板内容：报告结构、章节定义、样式配置
- 数据绑定：数据源映射、变量占位符、计算字段
- 输出格式：支持 Markdown、HTML、PDF、Word 等格式
- 可视化配置：图表类型、图表样式、数据展示方式

**模板元素**：
- 文本块：标题、段落、列表、表格
- 数据块：指标卡片、数据表格、统计图表
- 图表块：折线图、柱状图、饼图、拓扑图
- 代码块：日志片段、配置片段、SQL 语句
- 引用块：引用其他报告、引用外部文档

#### 2.5.2 报告生成与输出
系统需要支持基于模板生成格式化的分析报告。

**生成方式**：
- 自动生成：任务执行完成后自动生成报告
- 手动生成：用户手动触发报告生成
- 定时生成：按周期生成汇总报告（日报、周报、月报）
- 按需生成：通过 Chatbot 或 API 按需生成报告

**输出配置**：
- 输出格式：Markdown、HTML、PDF、Word、Excel
- 输出位置：本地存储、对象存储、邮件发送
- 分发方式：邮件、钉钉、企业微信、站内消息
- 访问控制：报告的查看权限、下载权限

**报告特性**：
- 支持报告的版本管理和历史查询
- 支持报告的对比分析（对比不同时间段的报告）
- 支持报告的导出和分享
- 支持报告的在线预览和交互式展示
- 支持报告中的数据钻取和详情查看

#### 2.5.3 模板编辑器
系统需要提供可视化的模板编辑器，便于用户自定义报告模板。

**编辑器功能**：
- 拖拽式布局：通过拖拽方式组织报告结构
- 所见即所得：实时预览报告效果
- 变量绑定：可视化配置数据源和变量映射
- 样式配置：配置字体、颜色、间距等样式
- 模板测试：使用样例数据测试模板效果

**模板库**：
- 内置模板：系统提供常用的报告模板
- 自定义模板：用户创建的私有模板
- 共享模板：团队共享的模板
- 模板市场：社区贡献的模板（可选）

### 2.6 身份认证与授权

#### 2.6.1 多种身份认证方式
系统需要支持多种身份认证方式，便于与企业现有的身份认证系统集成。

**认证方式**：
- **本地账号认证**：系统内置的用户名密码认证
- **LDAP/AD 认证**：集成企业 LDAP 或 Active Directory
- **OAuth 2.0 认证**：支持第三方 OAuth 2.0 提供商（如 GitHub、GitLab、Google 等）
- **SAML 2.0 认证**：支持企业级 SAML 单点登录
- **CAS 认证**：支持 CAS（Central Authentication Service）单点登录
- **OIDC 认证**：支持 OpenID Connect 协议

**认证配置**：
- 支持配置多个认证源
- 支持设置认证优先级和顺序
- 支持启用/禁用特定认证方式
- 支持认证源的测试和验证

**LDAP/AD 集成**：
- 配置 LDAP 服务器地址和端口
- 配置 Base DN 和搜索过滤器
- 支持 LDAP 用户属性映射（用户名、邮箱、部门等）
- 支持 LDAP 组映射到系统角色
- 支持 LDAP 连接池和超时配置
- 支持 LDAPS（LDAP over SSL/TLS）

**OAuth 2.0 集成**：
- 配置 OAuth 2.0 提供商（Client ID、Client Secret、授权端点等）
- 支持常见的 OAuth 2.0 提供商（GitHub、GitLab、Google、Microsoft 等）
- 支持自定义 OAuth 2.0 提供商
- 支持 OAuth 2.0 用户信息映射

**SAML 2.0 集成**：
- 配置 SAML IdP（Identity Provider）元数据
- 配置 SAML SP（Service Provider）信息
- 支持 SAML 断言签名验证
- 支持 SAML 属性映射

**认证特性**：
- 支持多因素认证（MFA）（可选）
- 支持记住登录状态
- 支持会话超时配置
- 支持单点登录（SSO）
- 支持单点登出（SLO）
- 支持用户首次登录自动创建账号

#### 2.6.2 用户管理
系统需要支持用户的统一管理，无论用户来自哪种认证源。

**用户信息**：
- 基础信息：用户名、邮箱、姓名、部门、职位
- 认证信息：认证源类型、外部用户 ID、最后登录时间
- 状态信息：账号状态（启用/禁用）、锁定状态
- 扩展信息：用户头像、联系方式、备注

**用户同步**：
- 支持从 LDAP/AD 同步用户信息
- 支持定期同步和手动同步
- 支持增量同步和全量同步
- 支持用户信息的自动更新

**用户映射**：
- 支持外部用户与系统用户的映射
- 支持多个认证源的用户合并（同一用户通过不同方式登录）
- 支持用户属性的映射规则配置

#### 2.6.3 基于资源所有权的权限模型
系统需要实现基于资源所有权的权限管理机制，确保资源的安全访问和操作控制。

**所有权模型**：
- **创建者（Creator）**：创建资源的用户，自动成为该资源的第一个 Owner
- **所有者（Owner）**：资源的所有者，可以有多个，拥有资源的完全控制权
- **查看者（Viewer）**：只能查看资源信息，不能修改或删除

**权限规则**：
- 创建资源时，创建者自动成为该资源的 Owner
- Owner 可以添加或移除其他 Owner（至少保留一个 Owner）
- 只有 Owner 可以修改资源的配置和属性
- 只有 Owner 可以删除资源
- 只有 Owner 可以管理资源的权限（添加/移除 Owner 或 Viewer）
- Viewer 只能查看资源信息，不能进行任何修改操作
- 非 Owner 和非 Viewer 的用户无法查看资源

**资源操作权限**：
- **创建**：所有登录用户都可以创建资源
- **查看**：Owner 和 Viewer 可以查看资源详情
- **修改**：仅 Owner 可以修改资源配置、属性、标签等
- **删除**：仅 Owner 可以删除资源
- **权限管理**：仅 Owner 可以添加/移除其他 Owner 或 Viewer

#### 2.6.4 权限管理功能

**Owner 管理**：
- 添加 Owner：Owner 可以将其他用户添加为 Owner
- 移除 Owner：Owner 可以移除其他 Owner（至少保留一个 Owner）
- Owner 转让：Owner 可以将所有权转让给其他用户
- Owner 列表：显示资源的所有 Owner

**Viewer 管理**：
- 添加 Viewer：Owner 可以将其他用户添加为 Viewer
- 移除 Viewer：Owner 可以移除 Viewer
- Viewer 列表：显示资源的所有 Viewer

**权限查询**：
- 用户可以查询自己拥有的资源（作为 Owner）
- 用户可以查询自己可以查看的资源（作为 Viewer）
- 用户可以查询自己创建的资源

**权限继承**：
- 拓扑关系不继承权限（父节点的 Owner 不自动成为子节点的 Owner）
- Agent 关联到节点时，需要检查用户是否是节点的 Owner
- 任务执行时，需要检查用户是否有权限访问相关资源

#### 2.6.5 权限控制实现

**资源级权限控制**：
- 每个资源都有独立的权限配置
- 资源的权限信息包括：创建者、Owner 列表、Viewer 列表
- 资源操作前需要进行权限检查

**操作级权限控制**：
- 查看操作：检查用户是否是 Owner 或 Viewer
- 修改操作：检查用户是否是 Owner
- 删除操作：检查用户是否是 Owner
- 权限管理操作：检查用户是否是 Owner

**权限检查流程**：
1. 用户发起操作请求
2. 系统获取资源的权限信息
3. 检查用户是否有权限执行该操作
4. 如果有权限，执行操作；否则返回权限不足错误

**权限异常处理**：
- 权限不足时，返回明确的错误信息
- 记录权限检查失败的审计日志
- 支持权限申请流程（可选）

### 2.7 数据集成与同步

#### 2.7.1 监控系统集成
系统需要与现有监控系统集成，获取资源的实时监控数据。

**集成需求**：
- 系统需要支持与主流监控系统集成（如 Prometheus、Grafana、Zabbix、Nagios、Datadog 等）
- 系统需要支持配置多个监控系统实例
- 系统需要提供统一的监控数据访问接口
- 系统需要支持自定义监控数据源的接入

**数据获取需求**：
- 系统需要支持查询监控指标数据（实时和历史）
- 系统需要支持嵌入监控仪表盘到资源详情页
- 系统需要支持获取监控系统的告警规则
- 系统需要支持监控数据的缓存和聚合

**数据同步需求**：
- 系统需要支持实时查询监控数据（用户查看时获取最新数据）
- 系统需要支持定时同步监控数据到本地缓存
- 系统需要支持接收监控系统主动推送的告警事件
- 系统需要支持按需加载监控数据（根据用户操作）

#### 2.7.2 CMDB 系统集成
系统需要与 CMDB（配置管理数据库）系统集成，同步资源配置信息。

**集成需求**：
- 系统需要支持与 CMDB 系统集成，获取资源配置信息
- 系统需要支持多种数据同步方式（API、数据库、消息队列、文件导入）
- 系统需要支持配置多个 CMDB 系统

**同步策略需求**：
- 系统需要支持全量同步所有资源
- 系统需要支持增量同步变更的资源
- 系统需要支持用户手动触发同步特定资源
- 系统需要支持选择性同步（按类型、范围筛选）
- 系统需要支持配置同步的时间和频率

**数据映射需求**：
- 系统需要支持配置 CMDB 字段到系统字段的映射规则
- 系统需要支持字段值的转换和格式化
- 系统需要支持多个 CMDB 系统的数据合并
- 系统需要支持自定义数据映射逻辑

**冲突处理需求**：
- 系统需要支持配置数据冲突的处理策略（优先级、合并、人工审核）
- 系统需要记录所有数据冲突和处理结果
- 系统需要在数据冲突时通知相关人员

#### 2.7.3 告警系统集成
系统需要与现有告警系统集成，接收和处理告警事件。

**告警接收需求**：
- 系统需要支持多种方式接收告警（Webhook、API 轮询、消息队列、邮件解析）
- 系统需要支持配置多个告警系统

**告警处理需求**：
- 系统需要解析告警内容，提取关键信息（资源、级别、时间、描述等）
- 系统需要将告警关联到对应的资源节点
- 系统需要更新资源的告警状态
- 系统需要支持告警触发 Agent 执行故障分析

**告警转发需求**：
- 系统需要支持将内部产生的告警转发到外部告警系统
- 系统需要支持告警的格式转换和内容定制
- 系统需要支持告警的聚合和去重

### 2.8 告警与通知管理

#### 2.8.1 告警规则配置
系统需要支持灵活的告警规则配置，实现智能告警。

**告警级别**：
- **严重（Critical）**：影响业务的严重故障，需要立即处理
- **警告（Warning）**：可能影响业务的问题，需要关注
- **信息（Info）**：一般性信息，仅供参考

**告警规则类型**：
- **阈值告警**：监控指标超过阈值时触发（如 CPU > 80%）
- **状态告警**：资源状态变化时触发（如服务下线）
- **趋势告警**：监控指标趋势异常时触发（如流量突增）
- **复合告警**：多个条件组合触发（如 CPU 高且内存高）
- **智能告警**：基于 AI 分析的异常检测告警

**告警规则配置**：
- 告警名称和描述
- 触发条件（指标、阈值、持续时间等）
- 告警级别
- 关联资源（节点、层次、标签等）
- 通知方式和接收人
- 告警抑制规则（避免重复告警）

#### 2.8.2 告警处理机制

**告警聚合**：
- 相同资源的相同告警在时间窗口内只触发一次
- 相关资源的告警聚合为一个告警组
- 支持自定义聚合规则

**告警去重**：
- 基于告警指纹（资源 + 告警类型 + 条件）去重
- 避免同一问题重复通知
- 支持告警恢复通知

**告警升级**：
- 告警未处理超过一定时间自动升级
- 升级后通知更高级别的接收人
- 支持多级升级策略

**告警抑制**：
- 维护期间抑制告警
- 已知问题抑制告警
- 下游依赖故障时抑制上游告警

**告警确认和关闭**：
- 用户可以确认告警（表示已知晓）
- 用户可以关闭告警（表示已处理）
- 记录告警的处理过程和结果

#### 2.8.3 通知渠道管理

**通知方式需求**：
- 系统需要支持多种通知方式（邮件、短信、钉钉、企业微信、飞书、Slack、站内消息、电话、Webhook）
- 系统需要支持配置多个通知渠道

**通知配置需求**：
- 系统需要支持配置通知渠道的连接信息
- 系统需要支持配置通知模板（标题、内容、格式）
- 系统需要支持配置通知规则（告警级别与通知方式的映射）
- 系统需要支持配置接收人和接收组

**通知策略需求**：
- 系统需要支持不同级别的告警使用不同的通知方式
- 系统需要支持配置通知的静默时间（如夜间不发短信）
- 系统需要支持通知的频率限制（避免通知轰炸）
- 系统需要支持通知失败的重试机制

**值班管理需求**：
- 系统需要支持配置值班表（值班人员和值班时间）
- 系统需要支持告警自动通知当前值班人员
- 系统需要支持值班轮换和临时调整
- 系统需要支持值班日历和提醒

### 2.9 Chatbot 交互

#### 2.9.1 对话式交互
系统需要提供 Chatbot 界面，支持自然语言交互。

**交互能力**：
- 资源查询：查询资源信息、状态、配置等
- 拓扑查询：查询节点关系、依赖链路等
- 任务执行：通过对话启动任务、查询任务状态
- 故障诊断：描述故障现象，获取诊断建议
- 知识问答：查询运维知识、最佳实践等

**对话特性**：
- 支持多轮对话，保持上下文
- 支持意图识别和实体提取
- 支持模糊查询和智能推荐
- 支持对话历史记录和回溯

#### 2.9.2 资源与工具指定
在对话过程中，用户可以指定资源和工具来执行临时任务。

**资源指定**：
- 通过名称指定资源
- 通过标签筛选资源
- 通过拓扑关系选择资源
- 通过可视化界面选择资源

**工具指定**：
- 选择预定义的 Agent
- 选择特定的 LLM 模型
- 选择特定的提示词模板
- 配置临时的执行参数

**临时任务**：
- 即时执行，无需预先配置
- 支持任务参数的动态调整
- 支持任务执行过程的实时反馈
- 支持任务结果的交互式展示

## 3. 前端界面需求

### 3.1 功能模块划分

**主导航模块**：
- **首页/仪表盘**：展示系统概览、关键指标、最近告警、任务执行情况
- **资源管理**：资源列表、资源详情、资源创建/编辑
- **拓扑视图**：拓扑图可视化、拓扑编辑、拓扑分析
- **Agent 管理**：Agent 列表、Agent 配置、Agent 关联
- **任务中心**：任务列表、任务详情、任务执行历史
- **报告中心**：报告列表、报告查看、报告模板管理
- **告警中心**：告警列表、告警详情、告警规则配置
- **Chatbot**：对话界面、历史记录
- **系统设置**：用户管理、权限配置、LLM 配置、系统配置

### 3.2 核心页面设计

**拓扑视图页面**：
- 左侧：层次树、资源列表、搜索过滤
- 中间：拓扑图画布（主要区域）
- 右侧：节点详情面板（可折叠）
- 顶部：工具栏（布局切换、缩放、导出、设置等）
- 底部：小地图（可选）

**资源详情页面**：
- 顶部：资源基本信息、状态、操作按钮
- Tab 页：
  - 概览：关键指标、最近告警、关联资源
  - 监控：嵌入监控图表
  - 日志：日志查询和展示
  - 拓扑：该资源的拓扑关系图
  - Agent：关联的 Agent 列表
  - 任务：相关任务执行历史
  - 配置：资源配置信息
  - 权限：Owner 和 Viewer 管理

**任务执行页面**：
- 任务列表：支持筛选、排序、搜索
- 任务详情：
  - 任务基本信息
  - 执行进度（实时更新）
  - 执行日志（流式展示）
  - 执行结果（结构化展示）
  - 生成的报告

**Chatbot 页面**：
- 对话区域：消息列表、输入框
- 快捷操作：常用命令、资源选择器
- 上下文面板：当前选中的资源、工具
- 历史记录：对话历史、收藏的对话

### 3.3 用户交互流程

**资源创建流程**：
1. 点击"创建资源"按钮
2. 选择资源类型
3. 填写资源信息（表单或向导）
4. 配置监控和告警（可选）
5. 确认创建
6. 跳转到资源详情页

**Agent 关联流程**：
1. 在资源详情页点击"关联 Agent"
2. 选择 Agent 类型或已有 Agent
3. 配置执行参数
4. 配置触发条件
5. 确认关联
6. 可以立即执行或等待触发

**故障诊断流程**：
1. 收到告警通知或发现异常
2. 打开资源详情页查看监控和日志
3. 点击"故障诊断"按钮
4. 系统自动执行故障分析 Agent
5. 实时展示分析进度和日志
6. 展示分析结果和建议
7. 可以继续执行根因分析或优化建议

**Chatbot 交互流程**：
1. 打开 Chatbot 界面
2. 输入问题或命令（如"查询应用 A 的状态"）
3. 系统识别意图和实体
4. 展示查询结果或执行操作
5. 支持多轮对话（如"分析它的性能问题"）
6. 可以在对话中选择资源、Agent、LLM
7. 执行任务并展示结果

### 3.4 响应式设计

**桌面端（>1200px）**：
- 完整功能展示
- 多列布局
- 拓扑图全屏展示

**平板端（768px-1200px）**：
- 简化布局
- 部分面板可折叠
- 拓扑图适配

**移动端（<768px）**：
- 单列布局
- 简化功能
- 重点展示告警和任务状态
- 支持基础的资源查看和 Chatbot 交互

## 4. 非功能性需求

### 4.1 性能要求
- 拓扑图渲染：支持 10000+ 节点的流畅展示（使用虚拟渲染和 WebGL）
- 查询响应：资源查询响应时间 < 1 秒
- 任务执行：支持 100+ 并发任务执行
- LLM 调用：单次调用响应时间 < 30 秒
- 页面加载：首屏加载时间 < 3 秒
- 实时更新：告警和任务状态实时更新（WebSocket）

### 4.2 可用性要求
- 系统可用性：99.9%
- 数据持久化：所有配置和任务结果需持久化存储
- 故障恢复：支持任务的断点续传和失败重试

### 4.3 安全性要求
- 身份认证：支持多种认证方式（本地账号、LDAP/AD、OAuth 2.0、SAML 2.0 等）
- 单点登录：支持企业级 SSO 集成
- 访问控制：基于资源所有权的访问控制（Owner/Viewer 模型）
- 权限隔离：不同用户只能访问自己有权限的资源
- 数据加密：敏感数据（如凭证、密码）需加密存储
- 传输加密：支持 HTTPS 和 LDAPS
- 会话管理：支持会话超时、单点登出
- 审计日志：记录所有关键操作的审计日志，包括登录、权限变更等

### 4.4 可扩展性要求
- 支持水平扩展，应对资源规模增长
- 支持插件化架构，便于扩展新的 Agent 类型
- 支持多租户，隔离不同团队的数据

### 4.5 可观测性要求
- 系统监控：监控系统自身的性能和健康状态
- 任务监控：监控任务执行状态和成功率
- LLM 监控：监控 LLM 调用次数、成本、延迟
- 告警通知：支持多种告警通知方式（邮件、短信、钉钉等）

## 5. 技术约束

### 5.1 技术栈
- 后端语言：Java 21
- 后端框架：Spring Boot 3.4.1
- 数据库：MySQL 8.0+（关系数据）、Neo4j（图数据库，可选）
- 缓存：Redis
- 消息队列：RabbitMQ 或 Kafka（可选）
- 前端框架：待定（Vue 3 或 React）

### 5.2 架构要求
- 采用 DDD 分层架构
- 模块化设计，便于维护和扩展
- 支持微服务化改造（未来）

### 5.3 集成要求
- 支持与现有监控系统集成（Prometheus、Grafana 等）
- 支持与现有告警系统集成
- 支持与 CMDB 系统集成
- 提供 REST API 供外部系统调用

## 6. 关键业务规则

### 6.1 拓扑管理规则
- 节点删除时，需要检查是否有关联关系，提示用户确认
- 节点删除时，需要检查用户是否是 Owner
- 关系创建时，需要验证节点是否存在，且用户是否有权限访问
- 分层定义需要避免循环依赖

### 6.2 权限管理规则
- 资源创建时，创建者自动成为第一个 Owner
- 资源至少保留一个 Owner，不能删除最后一个 Owner
- Owner 可以添加或移除其他 Owner 和 Viewer
- 只有 Owner 可以修改和删除资源
- 权限变更需要记录审计日志

### 6.3 Agent 执行规则
- Agent 执行前需要检查用户是否有权限访问相关资源
- Agent 关联到节点时，需要检查用户是否是节点的 Owner
- Agent 执行失败时，需要记录详细的错误信息
- Agent 执行结果需要关联到对应的节点

### 6.4 LLM 调用规则
- LLM 调用需要控制成本，超过预算时告警或拒绝
- LLM 调用失败时，需要有降级策略
- LLM 调用需要记录输入输出，便于审计和优化

### 6.5 任务调度规则
- 同一节点的任务需要串行执行，避免冲突
- 高优先级任务可以抢占低优先级任务
- 任务执行超时需要自动终止
- 任务执行前需要检查用户是否有权限访问相关资源

## 7. 用户角色

### 7.1 系统管理员
- 管理用户账号
- 配置 LLM 服务
- 管理系统配置
- 查看所有资源（不受权限限制）

### 7.2 运维工程师
- 创建和管理资源（作为 Owner）
- 配置和管理 Agent（需要是相关资源的 Owner）
- 执行任务和查看报告（需要有相关资源的访问权限）
- 使用 Chatbot 进行故障诊断
- 管理自己创建的资源的权限

### 7.3 开发工程师
- 查看有权限的应用和接口的拓扑关系（作为 Owner 或 Viewer）
- 查看应用的健康状态和性能指标
- 使用 Chatbot 查询资源信息
- 创建和管理自己的资源

### 7.4 业务人员
- 查看有权限的业务报表的健康状态（作为 Viewer）
- 查看业务链路的可用性
- 接收告警通知

## 8. 项目范围

### 8.1 第一阶段（MVP）
- 资源管理：支持基础设施、应用、接口的管理
- 拓扑管理：支持节点和关系的创建、查询、展示
- 分层管理：支持预定义的 5 层结构
- Agent 管理：支持巡检 Agent 和故障分析 Agent
- LLM 管理：支持配置 OpenAI 或 Claude
- 任务执行：支持定时任务和手动任务
- 报告管理：支持基础的报告模板和 Markdown/HTML 输出
- Chatbot：支持基础的资源查询和任务执行

### 8.2 第二阶段（增强）
- 支持更多资源类型（代码仓库、报表等）
- 支持自定义 Agent
- 支持提示词的版本管理和 A/B 测试
- 支持根因分析和优化建议
- 报告增强：支持可视化模板编辑器、PDF/Word 输出、报告对比分析
- 增强 Chatbot 的智能化能力
- 完善与外部系统的集成（更多监控系统、CMDB 系统）

### 8.3 第三阶段（高级）
- 支持图数据库（Neo4j）存储拓扑关系
- 支持复杂的拓扑分析（最短路径、影响分析等）
- 支持 Agent 的编排和协作
- 支持多租户和权限隔离
- 支持微服务化改造

## 9. 待澄清的问题

以下问题需要在需求分析阶段进一步明确：

1. **拓扑图展示**：
   - 拓扑图的可视化方式（力导向图、层次图、树形图等）？
   - 是否需要支持拓扑图的导出（图片、PDF 等）？

2. **Agent 执行**：
   - Agent 执行失败后的重试策略是什么？
   - Agent 执行结果如何通知用户（邮件、短信、站内信等）？

3. **LLM 选择**：
   - 优先支持哪个 LLM 服务（OpenAI、Claude、本地模型）？
   - 是否需要支持多个 LLM 服务的负载均衡？

4. **Chatbot 交互**：
   - Chatbot 的交互界面是 Web 还是独立的聊天窗口？
   - 是否需要支持语音交互？

5. **数据存储**：
   - 拓扑关系是否使用图数据库（Neo4j）还是关系数据库？
   - 任务执行历史需要保留多久？

6. **权限管理**：
   - 权限粒度是资源级别还是操作级别？
   - 是否需要支持数据权限隔离（不同团队看到不同的资源）？

7. **告警通知**：
   - 支持哪些告警通知方式（邮件、短信、钉钉、企业微信等）？
   - 告警规则如何配置？

8. **成本控制**：
   - LLM 调用的成本预算如何设置（按月、按任务、按用户）？
   - 超过预算后的处理策略是什么（拒绝、降级、告警）？

9. **报告模板**：
   - 第一阶段需要支持哪些内置报告模板？
   - 报告的输出格式优先级是什么（Markdown、HTML、PDF、Word）？
   - 报告是否需要支持多语言（中文、英文）？
   - 报告中的图表使用什么库实现（ECharts、Chart.js 等）？

10. **身份认证**：
   - 第一阶段优先支持哪种认证方式（本地账号、LDAP/AD、OAuth 2.0）？
   - 是否需要在 MVP 阶段就支持多种认证方式？

11. **拓扑图可视化**：
   - 第一阶段优先支持哪种布局算法（力导向、层次、树形）？
   - 是否需要在 MVP 阶段就支持拓扑图导出功能？

12. **数据集成**：
   - 第一阶段需要集成哪些监控系统（Prometheus、Grafana、Zabbix 等）？
   - 是否需要在 MVP 阶段就支持 CMDB 集成？
   - 数据同步的频率是多少（实时、每分钟、每小时）？

13. **告警通知**：
   - 第一阶段优先支持哪些通知方式（邮件、钉钉、企业微信）？
   - 是否需要在 MVP 阶段就支持值班管理？

14. **Agent 执行环境**：
   - Agent 执行环境优先选择哪种方式（容器化、进程隔离、线程池）？
   - 是否需要在 MVP 阶段就支持 Agent 编排？

## 10. 参考资料

- AIOps 最佳实践
- 拓扑管理系统设计
- LangGraph 多 Agent 协作框架
- CMDB 系统设计
- 监控告警系统设计
- Prometheus API 文档
- Grafana API 文档
- LDAP 集成最佳实践
- OAuth 2.0 和 SAML 2.0 规范

---

**文档版本**：v2.0  
**创建日期**：2024-11-20  
**最后更新**：2024-11-20  
**文档状态**：待确认

## 11. 更新日志

### v2.0（2024-11-20）
- 新增：拓扑图可视化详细需求（布局算法、交互操作、性能优化、导出功能）
- 新增：数据集成与同步机制（监控系统、CMDB、告警系统集成）
- 新增：告警与通知管理（告警规则、处理机制、通知渠道、值班管理）
- 新增：Agent 实现机制（执行环境、数据获取、与 LLM 交互流程）
- 新增：前端界面需求（功能模块、页面设计、交互流程、响应式设计）
- 完善：待澄清问题列表

### v1.0（2024-11-20）
- 初始版本
- 定义核心功能需求
- 定义非功能性需求
- 定义技术约束和项目范围
