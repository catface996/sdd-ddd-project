# F19: 集成 CMDB 系统数据

## 基本信息

- **Feature ID**: F19
- **Feature 名称**: 集成 CMDB 系统数据
- **优先级**: P1（第二阶段）
- **状态**: 待开发
- **负责人**: 待分配
- **预计工作量**: 待评估

## 用户故事

作为运维工程师，我希望集成 CMDB 系统数据，以便自动同步资源配置信息。

## 功能价值

- 自动同步资源信息
- 减少手工维护成本
- 保持数据一致性

## 核心功能

### 1. 配置 CMDB 连接
- 配置 CMDB 系统类型（自定义、ServiceNow、iTop 等）
- 配置连接信息（URL、API Key、认证方式）
- 测试连接
- 保存配置

### 2. 配置数据映射规则
- 配置资源类型映射（CMDB CI 类型 → 系统资源类型）
- 配置字段映射（CMDB 字段 → 系统字段）
- 配置关系映射（CMDB 关系 → 系统拓扑关系）
- 配置过滤条件（只同步特定资源）

### 3. 全量同步资源
- 手动触发全量同步
- 从 CMDB 拉取所有资源
- 按映射规则转换数据
- 创建或更新系统资源
- 生成同步报告

### 4. 增量同步资源
- 配置增量同步策略（定时、实时）
- 只同步变更的资源
- 检测新增、修改、删除的资源
- 更新系统资源
- 记录同步日志

### 5. 冲突处理
- 检测数据冲突（CMDB 数据 vs 系统数据）
- 配置冲突解决策略
  - CMDB 优先（覆盖系统数据）
  - 系统优先（保留系统数据）
  - 手动解决（提示用户选择）
- 记录冲突日志
- 提供冲突解决界面

### 6. 查看同步历史
- 查看所有同步记录
- 查看同步详情（成功、失败、冲突）
- 查看同步统计
- 导出同步报告

### 7. 双向同步（可选）
- 将系统资源变更同步回 CMDB
- 配置同步方向（单向/双向）
- 冲突检测和处理

## 验收标准

### AC1: 配置 CMDB 连接
**WHEN** 用户配置 CMDB 连接 **THEN** THE System **SHALL** 能够连接到 CMDB 系统

**WHEN** 用户测试连接 **THEN** THE System **SHALL** 验证连接是否成功并显示结果

### AC2: 配置数据映射
**WHEN** 用户配置数据映射 **THEN** THE System **SHALL** 支持资源类型、字段、关系的映射配置

**WHEN** 用户保存映射规则 **THEN** THE System **SHALL** 验证映射规则的正确性

### AC3: 全量同步
**WHEN** 用户触发全量同步 **THEN** THE System **SHALL** 从 CMDB 拉取所有资源并同步到系统

**WHEN** 全量同步完成 **THEN** THE System **SHALL** 生成同步报告，显示成功、失败、冲突的数量

### AC4: 增量同步
**WHEN** 配置增量同步 **THEN** THE System **SHALL** 定期检测 CMDB 的变更并同步

**WHEN** 检测到资源变更 **THEN** THE System **SHALL** 只同步变更的资源

### AC5: 冲突处理
**WHEN** 同步时发现数据冲突 **THEN** THE System **SHALL** 按配置的策略处理冲突

**WHEN** 冲突策略为手动解决 **THEN** THE System **SHALL** 提示用户选择保留哪个版本

**WHEN** 冲突解决后 **THEN** THE System **SHALL** 记录冲突处理日志

### AC6: 同步历史
**WHEN** 用户查看同步历史 **THEN** THE System **SHALL** 显示所有同步记录和详情

**WHEN** 同步失败 **THEN** THE System **SHALL** 记录失败原因并提供重试功能

## 依赖关系

### 前置依赖
- F01: 创建和管理 IT 资源

### 后置依赖
- 无

## 技术考虑

### CMDB 集成方式
- REST API 集成（推荐）
- 数据库直连（不推荐，耦合度高）
- 消息队列集成（实时同步）

### 数据映射
- 使用配置文件或数据库存储映射规则
- 支持复杂的字段转换（如日期格式、枚举值映射）
- 支持自定义转换脚本（如 Groovy、JavaScript）

### 同步策略
- 全量同步：适合初始化或定期校验
- 增量同步：适合日常同步，减少数据传输
- 实时同步：通过 Webhook 或消息队列实现

### 性能要求
- 全量同步 10000 个资源 < 10 分钟
- 增量同步延迟 < 5 分钟
- 冲突检测响应时间 < 1 秒

### 数据一致性
- 使用事务保证同步的原子性
- 记录详细的同步日志
- 提供数据校验和修复功能

## 界面设计要点

### CMDB 配置页面
- CMDB 系统列表
- 添加 CMDB 按钮
- 连接配置表单
  - 系统类型选择
  - URL、API Key 输入
  - 认证方式选择
  - 测试连接按钮
- 保存按钮

### 数据映射配置页面
- 资源类型映射表格
  - CMDB CI 类型
  - 系统资源类型
  - 映射关系
- 字段映射表格
  - CMDB 字段
  - 系统字段
  - 转换规则
- 关系映射表格
- 过滤条件配置
- 保存按钮

### 同步管理页面
- 顶部：全量同步、增量同步按钮
- 同步配置：
  - 同步方向（单向/双向）
  - 冲突策略
  - 增量同步频率
- 同步历史列表
  - 同步时间
  - 同步类型（全量/增量）
  - 同步结果（成功、失败、冲突数量）
  - 查看详情按钮

### 同步详情页面
- 同步摘要：成功、失败、冲突数量
- 资源列表：
  - 资源名称
  - 操作类型（新增、更新、删除）
  - 状态（成功、失败、冲突）
  - 错误信息
- 冲突列表：
  - 资源名称
  - 冲突字段
  - CMDB 值 vs 系统值
  - 解决操作（选择保留哪个）

## 测试要点

### 功能测试
- 测试配置 CMDB 连接
- 测试数据映射配置
- 测试全量同步
- 测试增量同步
- 测试冲突处理

### 集成测试
- 测试与不同 CMDB 系统的集成
- 测试各种数据类型的映射
- 测试复杂关系的同步

### 性能测试
- 测试大量资源的同步性能
- 测试增量同步的延迟
- 测试并发同步

### 异常测试
- 测试 CMDB 连接失败
- 测试数据格式错误
- 测试同步中断恢复

## 相关文档

- 需求文档: `doc/intent/blueprint.md` - 2.7.2 CMDB 集成
- Feature List: `doc/intent/feature-list.md` - F19

---

**创建日期**: 2024-11-20  
**最后更新**: 2024-11-20  
**文档版本**: v1.0
